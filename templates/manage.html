{% extends 'layout.html' %}

{% block title %}Manage Export Token - {{ user_email }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="text-center mb-10">
    <h1 class="text-3xl font-bold text-primary-600 mb-2">‚öôÔ∏è Manage Your Export Token</h1>
    <p class="text-gray-600">View and manage your permanent export URLs and access tokens</p>
  </div>

  <div class="bg-gray-50 border-l-4 border-primary-600 p-5 rounded-lg mb-6">
    <h3 class="text-lg font-semibold text-primary-600 mb-4">üìã Account Information</h3>
    <div class="space-y-3">
      <div class="flex justify-between items-center pb-3 border-b border-gray-200">
        <span class="font-semibold text-gray-800">User Email:</span>
        <span class="text-gray-600 font-mono break-all">{{ user_email }}</span>
      </div>
      <div class="flex justify-between items-center pb-3 border-b border-gray-200">
        <span class="font-semibold text-gray-800">Provider:</span>
        <span class="text-gray-600 font-mono">{{ provider|upper }}</span>
      </div>
      <div class="flex justify-between items-center">
        <span class="font-semibold text-gray-800">Export Token:</span>
        <span class="text-gray-600 font-mono break-all">{{ export_token }}</span>
      </div>
    </div>
  </div>

  <div class="bg-primary-50 border-l-4 border-primary-600 p-5 rounded-lg mb-6">
    <h3 class="text-lg font-semibold text-primary-600 mb-2 flex items-center gap-2">
      üîó Permanent Export URLs
    </h3>
    <p class="text-gray-700 mb-4">
      These URLs work forever without authentication. Keep them secret - anyone with these URLs can access your data!
    </p>
    
    <div class="bg-white p-4 rounded-lg border border-gray-300 mb-4">
      <div class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
        üìÑ Contacts Export (CSV)
      </div>
      <div class="flex gap-2 flex-col sm:flex-row">
        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-mono text-sm bg-gray-50" id="contactsUrl" value="{{ export_contacts_url }}" readonly>
        <button class="px-5 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors font-medium whitespace-nowrap" onclick="copyToClipboard('contactsUrl', this)">Copy</button>
      </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border border-gray-300">
      <div class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
        üìÖ Calendar Export (ICS)
      </div>
      <div class="flex gap-2 flex-col sm:flex-row">
        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-mono text-sm bg-gray-50" id="calendarUrl" value="{{ export_calendar_url }}" readonly>
        <button class="px-5 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors font-medium whitespace-nowrap" onclick="copyToClipboard('calendarUrl', this)">Copy</button>
      </div>
    </div>
  </div>

  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-5 rounded-lg mb-6">
    <h3 class="text-lg font-semibold text-yellow-700 mb-2 flex items-center gap-2">
      üîë Active Bearer Tokens
    </h3>
    <p class="text-gray-700 mb-4">
      These is your API access tokens used for authenticated requests. Each token was created when you authorized the app.
    </p>
    
    {% if tokens and tokens|length > 0 %}
      {% for t in tokens %}
      <div class="bg-white p-3 rounded-lg border border-gray-200 mb-2 font-mono text-sm">
        <div>
          <span class="text-primary-600 font-semibold">Token:</span> <span class="text-gray-700">{{ t }}</span>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="text-gray-600 italic text-center py-4">No active bearer tokens found.</div>
    {% endif %}
  </div>

  <div class="bg-yellow-50 border-l-4 border-red-500 p-5 rounded-lg">
    <h3 class="text-lg font-semibold text-red-600 mb-3 flex items-center gap-2">
      <span class="text-xl">‚ö†Ô∏è</span> Danger Zone
    </h3>
    <p class="text-gray-700 mb-2">
      <strong>Revoking your tokens will:</strong>
    </p>
    <ul class="text-gray-700 mb-4 ml-5 space-y-1 list-disc">
      <li>Delete all bearer tokens associated with your account</li>
      <li>Revoke OAuth access with {{ provider|capitalize }}</li>
      <li>Invalidate all export URLs permanently</li>
      <li>Remove all stored credentials from the database</li>
    </ul>
    <p class="text-red-600 font-semibold mb-4">
      ‚ö†Ô∏è This action cannot be undone. You will need to re-authorize to create new tokens.
    </p>
    
    <form id="revokeForm" method="POST" action="/manage/{{ export_token }}/revoke">
      <button class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold text-base" type="submit">
        üóëÔ∏è Revoke and Delete All Tokens
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Copy URL to clipboard
  function copyToClipboard(inputId, button) {
    const input = document.getElementById(inputId);
    const originalText = button.textContent;
    
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      document.execCommand('copy');
      button.textContent = '‚úì Copied!';
      button.classList.remove('bg-primary-600', 'hover:bg-primary-700');
      button.classList.add('bg-green-600');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-600');
        button.classList.add('bg-primary-600', 'hover:bg-primary-700');
      }, 2000);
    } catch (err) {
      button.textContent = '‚úó Failed';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    }
    
    // Deselect
    window.getSelection().removeAllRanges();
  }
  
  // Handle revoke form submission
  const form = document.getElementById('revokeForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const confirmMessage = 
      'Are you ABSOLUTELY SURE you want to revoke and delete all tokens?\n\n' +
      'This will:\n' +
      '‚Ä¢ Delete all bearer tokens\n' +
      '‚Ä¢ Invalidate all export URLs\n' +
      '‚Ä¢ Revoke OAuth access\n' +
      '‚Ä¢ Remove all stored credentials\n\n' +
      'This action CANNOT be undone!\n\n' +
      'Click OK to proceed or Cancel to go back.';
    
    if (!confirm(confirmMessage)) {
      return;
    }
      
    try {
      const resp = await fetch(form.action, { method: 'POST' });
      
      if (resp.ok) {
        alert('‚úì Successfully revoked all tokens and deleted credentials.\n\nYou will be redirected to the homepage.');
        window.location.href = '/';
      } else {
        const errorText = await resp.text();
        alert('‚úó Failed to revoke tokens.\n\nError: ' + (errorText || 'Unknown error') + '\n\nPlease check the server logs.');
      }
    } catch (error) {
      alert('‚úó Network error occurred.\n\nError: ' + error.message + '\n\nPlease try again or check your connection.');
    }
  });
  
  // Add click handlers to URL inputs for easy selection
  document.querySelectorAll('input[readonly]').forEach(input => {
    input.addEventListener('click', function() {
      this.select();
    });
  });
</script>
{% endblock %}
  
  .tokens-section h3 {
    margin-top: 0;
    color: #f9ab00;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .token-item {
    background: white;
    padding: 12px 15px;
    margin: 10px 0;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    font-family: monospace;
    font-size: 0.9em;
  }
  
  .token-prefix {
    color: #1a73e8;
    font-weight: 600;
  }
  
  .token-date {
    color: #666;
    font-size: 0.85em;
    margin-top: 5px;
  }
  
  .no-tokens {
    color: #666;
    font-style: italic;
    padding: 15px;
    text-align: center;
  }
  
  .danger-section {
    background: #fff3cd;
    border-left: 4px solid #ff6b6b;
    padding: 20px;
    margin: 30px 0;
    border-radius: 8px;
  }
  
  .danger-section h3 {
    margin-top: 0;
    color: #d32f2f;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .danger-section p {
    color: #666;
    margin-bottom: 15px;
  }
  
  .revoke-btn {
    padding: 12px 24px;
    background: #d32f2f;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    transition: background 0.3s;
  }
  
  .revoke-btn:hover { background: #b71c1c; }
  
  .warning-icon { font-size: 1.2em; }
  
  @media (max-width: 768px) {
    .info-row { flex-direction: column; gap: 5px; }
    .url-input-group { flex-direction: column; }
    .copy-btn { width: 100%; }
  }
</style>
{% endblock %}

{% block content %}
<div class="manage-container">
  <div class="page-header">
    <h1>‚öôÔ∏è Manage Your Export Token</h1>
    <p class="subtitle">View and manage your permanent export URLs and access tokens</p>
  </div>

  <div class="info-section">
    <h3 style="margin-top: 0; color: #1a73e8;">üìã Account Information</h3>
    <div class="info-row">
      <span class="info-label">User Email:</span>
      <span class="info-value">{{ user_email }}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Provider:</span>
      <span class="info-value">{{ provider|upper }}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Export Token:</span>
      <span class="info-value">{{ export_token }}</span>
    </div>
  </div>

  <div class="export-section">
    <h3>üîó Permanent Export URLs</h3>
    <p style="color: #666; margin-bottom: 15px;">
      These URLs work forever without authentication. Keep them secret - anyone with these URLs can access your data!
    </p>
    
    <div class="url-item">
      <div class="url-label">üìÑ Contacts Export (CSV)</div>
      <div class="url-input-group">
        <input type="text" class="url-input" id="contactsUrl" value="{{ export_contacts_url }}" readonly>
        <button class="copy-btn" onclick="copyToClipboard('contactsUrl', this)">Copy</button>
      </div>
    </div>
    
    <div class="url-item">
      <div class="url-label">üìÖ Calendar Export (ICS)</div>
      <div class="url-input-group">
        <input type="text" class="url-input" id="calendarUrl" value="{{ export_calendar_url }}" readonly>
        <button class="copy-btn" onclick="copyToClipboard('calendarUrl', this)">Copy</button>
      </div>
    </div>
  </div>

  <div class="tokens-section">
    <h3>üîë Active Bearer Tokens</h3>
    <p style="color: #666; margin-bottom: 15px;">
      These is your API access tokens used for authenticated requests. Each token was created when you authorized the app.
    </p>
    
    {% if tokens and tokens|length > 0 %}
      {% for t in tokens %}
      <div class="token-item">
        <div>
          <span class="token-prefix">Token:</span> {{ t }}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="no-tokens">No active bearer tokens found.</div>
    {% endif %}
  </div>

  <div class="danger-section">
    <h3><span class="warning-icon">‚ö†Ô∏è</span> Danger Zone</h3>
    <p>
      <strong>Revoking your tokens will:</strong>
    </p>
    <ul style="color: #666; margin: 10px 0 15px 20px;">
      <li>Delete all bearer tokens associated with your account</li>
      <li>Revoke OAuth access with {{ provider|capitalize }}</li>
      <li>Invalidate all export URLs permanently</li>
      <li>Remove all stored credentials from the database</li>
    </ul>
    <p style="color: #d32f2f; font-weight: 600;">
      ‚ö†Ô∏è This action cannot be undone. You will need to re-authorize to create new tokens.
    </p>
    
    <form id="revokeForm" method="POST" action="/manage/{{ export_token }}/revoke">
      <button class="revoke-btn" type="submit">üóëÔ∏è Revoke and Delete All Tokens</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Copy URL to clipboard
  function copyToClipboard(inputId, button) {
    const input = document.getElementById(inputId);
    const originalText = button.textContent;
    
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      document.execCommand('copy');
      button.textContent = '‚úì Copied!';
      button.classList.add('copied');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('copied');
      }, 2000);
    } catch (err) {
      button.textContent = '‚úó Failed';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    }
    
    // Deselect
    window.getSelection().removeAllRanges();
  }
  
  // Handle revoke form submission
  const form = document.getElementById('revokeForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const confirmMessage = 
      'Are you ABSOLUTELY SURE you want to revoke and delete all tokens?\n\n' +
      'This will:\n' +
      '‚Ä¢ Delete all bearer tokens\n' +
      '‚Ä¢ Invalidate all export URLs\n' +
      '‚Ä¢ Revoke OAuth access\n' +
      '‚Ä¢ Remove all stored credentials\n\n' +
      'This action CANNOT be undone!\n\n' +
      'Click OK to proceed or Cancel to go back.';
    
    if (!confirm(confirmMessage)) {
      return;
    }
      
    try {
      const resp = await fetch(form.action, { method: 'POST' });
      
      if (resp.ok) {
        alert('‚úì Successfully revoked all tokens and deleted credentials.\n\nYou will be redirected to the homepage.');
        window.location.href = '/';
      } else {
        const errorText = await resp.text();
        alert('‚úó Failed to revoke tokens.\n\nError: ' + (errorText || 'Unknown error') + '\n\nPlease check the server logs.');
      }
    } catch (error) {
      alert('‚úó Network error occurred.\n\nError: ' + error.message + '\n\nPlease try again or check your connection.');
    }
  });
  
  // Add click handlers to URL inputs for easy selection
  document.querySelectorAll('.url-input').forEach(input => {
    input.addEventListener('click', function() {
      this.select();
    });
  });
</script>
{% endblock %}